<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnowMe - Pookie Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #FFF9FB;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .no-scroll {
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .btn-primary {
            background-color: #fb7185;
            color: white;
            box-shadow: 0 4px 0 rgb(225, 110, 130);
            transition: all 0.2s;
        }

        .btn-primary:active {
            box-shadow: none;
            transform: translateY(4px);
        }
        
        .btn-secondary {
            background-color: #fff0f3;
            color: #fb7185;
            border: 2px solid #fbcfe8;
            box-shadow: 0 4px 0 #fbcfe8;
            transition: all 0.2s;
        }
        
                .btn-secondary:active {
            box-shadow: none;
            transform: translateY(4px);
        }

        /* NEW ENHANCEMENTS */
        .rounded-pookie { border-radius: 2.5rem; }
        .rounded-pill-pookie { border-radius: 3.5rem; }

        .hover-lift { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hover-lift:hover { transform: translateY(-5px) scale(1.02); }

        .focus-scale { transition: all 0.2s ease; }
        .focus-scale:focus { transform: scale(1.02); box-shadow: 0 10px 25px -5px rgba(251, 113, 133, 0.2); }

        .btn-glow { animation: glowing 2s infinite; }
        @keyframes glowing {
            0% { box-shadow: 0 4px 0 rgb(225, 110, 130), 0 0 5px rgba(251, 113, 133, 0.2); }
            50% { box-shadow: 0 4px 0 rgb(225, 110, 130), 0 0 20px rgba(251, 113, 133, 0.6); }
            100% { box-shadow: 0 4px 0 rgb(225, 110, 130), 0 0 5px rgba(251, 113, 133, 0.2); }
        }

        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
        }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* EXISTING ANIMATIONS */
        .animate-pookie-bounce { animation: bounce 5s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(3deg) scale(1); }
            50% { transform: translateY(-30px) rotate(-10deg) scale(1.05); }
        }

        .glitter-border {
            position: absolute;
            background: linear-gradient(90deg, transparent, #fda4af, #fbcfe8, #fda4af, transparent);
            background-size: 200% 100%;
            animation: moveGlitter 6s linear infinite;
            z-index: 50;
        }
        .border-h { height: 4px; width: 100%; left: 0; }
        .border-v { width: 4px; height: 100%; top: 0; }
        @keyframes moveGlitter {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .toast-enter { animation: toastSlideIn 0.3s ease-out forwards; }
        .toast-exit { animation: toastSlideOut 0.3s ease-in forwards; }
        @keyframes toastSlideIn {
            from { transform: translateY(100%) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes toastSlideOut {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(20px) scale(0.9); opacity: 0; }
        }
    </style>

</head>
<body class="min-h-screen text-rose-900">

    <div id="app"></div>

    <div id="toast-container" class="fixed bottom-10 left-0 right-0 z-[1000] flex justify-center pointer-events-none"></div>

    <script type="module">
        // --- CONFIGURATION & SETUP ---
        const DEV_MODE = location.protocol === 'file:' || location.hostname === 'localhost';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let app, db, auth;

       // PASTE THIS NEW CODE
const firebaseConfig = {
  apiKey: "AIzaSyCUDWKDMwl3DRVxHvY85K-Y4ceBGPUkAe8",
  authDomain: "pookiequizlive.firebaseapp.com",
  projectId: "pookiequizlive",
  storageBucket: "pookiequizlive.firebasestorage.app",
  messagingSenderId: "340758596918",
  appId: "1:340758596918:web:96c439644cc0f4e5217797",
  measurementId: "G-XB9D8TT1PZ"
};

// Initialize directly
app = initializeApp(firebaseConfig);
db = getFirestore(app);
auth = getAuth(app);


        const appId = 'pookie-quiz-live';


        // --- STATE MANAGEMENT ---
        let defaultState = {
            view: 'landing',
            isLoggedIn: false,
            isGuest: false,
            userEmail: '',
            profileCompleted: false,
            profile: { 
                name: '', 
                dob: '', 
                zodiac: '', 
                element: '', 
                vibe: '', 
                emoji: 'üß∏', 
                knownFor: '' 
            },
            selectedMode: 'friends',
            questions: [],
            activeQuiz: null,
            quizId: null,
            friendName: '',
            friendAnswers: [],
            attemptResult: null,
            attempts: [],
            editDraft: {},
            showDashboardConfirm: false,
            showTemplateModal: false,
            showProfileEditor: false

        };

        // Load State from LocalStorage
        let state = { ...defaultState };
        const STORAGE_KEY = 'knowme_pookie_state_v2'; 

        function loadLocalState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    state = { ...defaultState, ...parsed };
                    state.showDashboardConfirm = false;
                    state.showProfileEditor = false;
                }
            } catch (e) {
                console.error("Failed to load state", e);
            }
        }

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state", e);
            }
        }

        loadLocalState();
                      const QUIZ_TEMPLATES = {
            friends: [
                { q: "My go-to mood when I‚Äôm tired?", options: [] },
                { q: "What‚Äôs my biggest pet peeve?", options: ["Loud chewing", "Fake people", "Being ignored", "Being rushed"] },
                { q: "What time of day am I most active?", options: ["Morning", "Afternoon", "Night"] },
                { q: "What food can always fix my mood?", options: [] },
                { q: "If I‚Äôm quiet for too long, what does it usually mean?", options: ["I‚Äôm sad", "I‚Äôm overthinking", "I‚Äôm busy", "I‚Äôm angry"] },
                { q: "My comfort activity is...", options: [] },
                { q: "What kind of friend am I in a crisis?", options: ["Listener", "Problem-solver", "Distractor", "Silent supporter"] },
                { q: "One thing I can never say ‚Äúno‚Äù to?", options: [] },
                { q: "What annoys me more?", options: ["Being late", "Being lied to"] },
                { q: "My favorite way to spend a free day?", options: [] },
                { q: "Am I more:", options: ["Emotional", "Logical"] },
                { q: "What‚Äôs my most-used phrase?", options: [] },
                { q: "If I disappear, where am I most likely?", options: ["Sleeping", "Overthinking", "Watching something", "Offline by choice"] },
                { q: "What do I value more?", options: ["Loyalty", "Honesty"] },
                { q: "One word that describes me best?", options: [] }
            ],
            couple: [
                { q: "What nickname suits me the most?", options: [] },
                { q: "Am I more:", options: ["Calm pookie", "Chaotic pookie"] },
                { q: "What small thing makes me smile instantly?", options: [] },
                { q: "If I‚Äôm sad, what do I secretly want?", options: ["Space", "Reassurance", "Distraction"] },
                { q: "Am I more:", options: ["Clingy", "Independent"] },
                { q: "What kind of compliments affect me most?", options: ["Looks", "Effort", "Personality"] },
                { q: "My favorite emoji describes me best?", options: [] },
                { q: "When I miss someone, I usually:", options: ["Text", "Stay quiet", "Act normal"] },
                { q: "One habit I have that‚Äôs low-key cute?", options: [] },
                { q: "What makes me feel safe?", options: [] },
                { q: "Am I more:", options: ["Words person", "Actions person"] },
                { q: "My comfort word when overwhelmed?", options: [] },
                { q: "Do I fall asleep easily?", options: ["Yes", "No, brain won‚Äôt shut up"] },
                { q: "What vibe do I give?", options: ["Soft", "Protective", "Mysterious"] },
                { q: "My ideal late-night activity?", options: [] }
            ],
            crush: [
                { q: "What‚Äôs the first thing people usually notice about me?", options: [] },
                { q: "Am I more:", options: ["Introvert", "Ambivert", "Extrovert"] },
                { q: "What kind of conversations do I enjoy most?", options: [] },
                { q: "How do I act when I like someone?", options: ["Quiet", "Teasing", "Extra caring"] },
                { q: "My love language is?", options: ["Time", "Words", "Acts", "Loyalty"] },
                { q: "What scares me most in relationships?", options: [] },
                { q: "Do I believe in:", options: ["Slow burn", "Love at first sight"] },
                { q: "What kind of energy attracts me?", options: [] },
                { q: "When I‚Äôm nervous, I usually:", options: ["Talk less", "Joke", "Avoid eye contact"] },
                { q: "One green flag I value a lot?", options: [] },
                { q: "Am I more:", options: ["Romantic", "Realistic"] },
                { q: "What ruins attraction instantly for me?", options: [] },
                { q: "Do I open up easily?", options: ["Yes", "Only to a few"] },
                { q: "My ideal bond feels like...", options: [] },
                { q: "If you had to describe me in one word, what would it be?", options: [] }
            ]
        };

        const MODES = {
            friends: { label: 'Besties', icon: 'users', emoji: 'üëØ‚Äç‚ôÄÔ∏è' },
            couple: { label: 'Pookies', icon: 'heart', emoji: 'üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®' },
            crush: { label: 'Crush', icon: 'zap', emoji: 'üëÄ' }
        };

        // --- RENDER ENGINE ---
        function render() {
            saveState(); 

            const root = document.getElementById('app');
            let content = '';
            
            // Only remove fixed elements that are NOT the template modal
document.querySelectorAll('.fixed.inset-0:not(#template-modal-container)').forEach(el => el.remove());


              if (state.view === 'landing') {
                content = `
                    <div class="no-scroll bg-[#FFF9FB] p-6 text-center overflow-hidden">
                        <div class="absolute top-20 left-[10%] text-rose-200 animate-float opacity-50"><i data-lucide="heart" fill="currentColor" size="24"></i></div>
                        <div class="absolute top-40 right-[15%] text-pink-200 animate-float opacity-40" style="animation-delay: 1s;"><i data-lucide="sparkles" size="30"></i></div>
                        <div class="absolute bottom-40 left-[15%] text-rose-100 animate-float opacity-60" style="animation-delay: 2s;"><i data-lucide="heart" fill="currentColor" size="40"></i></div>
                        
                        <div class="glitter-border border-h top-0"></div>
                        <div class="glitter-border border-h bottom-0"></div>
                        <div class="glitter-border border-v left-0"></div>
                        <div class="glitter-border border-v right-0"></div>
                        
                        <div class="space-y-6 relative z-10 scale-90 md:scale-100 mt-10">
                           <div class="relative inline-block">
                                <div class="w-32 h-32 md:w-44 md:h-44 bg-rose-100 rounded-pookie flex items-center justify-center mx-auto mb-6 animate-pookie-bounce shadow-xl border-4 border-white">
                                    <i data-lucide="candy" class="text-rose-400" size="80"></i>
                                </div>
                            </div>
                            <h1 class="text-4xl md:text-7xl font-black tracking-tight text-rose-900 leading-[1.1]">
                                How well do your <br /> <span class="text-rose-400 italic">pookies</span> know you?
                            </h1>
                            <p class="text-rose-300 text-base md:text-lg font-medium max-w-sm mx-auto">
                                Create a cute quiz to see who really pays attention to the little things. ‚ú®
                            </p>
                        </div>
                        <div class="w-full max-w-xs space-y-4 mt-8 relative z-10">
                          <button onclick="handleStartOwnQuiz()" class="w-full py-4 md:py-5 text-lg md:text-xl btn-primary rounded-pookie font-bold btn-glow hover-lift">
                            Let's Start Pookie ! üéÄ
                          </button>
                        </div>
                    </div>
                `;
            } 


            else if (state.view === 'auth') {
                content = `
                <div class="no-scroll bg-[#FFF9FB] p-6 flex flex-col items-center justify-center">
                    <div class="glitter-boundary"></div>
                    <div class="w-full max-w-md space-y-6 relative z-10">
                        <div class="text-center space-y-2 mb-8">
                            <div class="inline-block p-4 bg-white rounded-full shadow-lg mb-2">
                                <i data-lucide="lock" class="text-rose-400" size="32"></i>
                            </div>
                            <h2 class="text-3xl font-black text-rose-900">Welcome Back üß∏</h2>
                            <p class="text-rose-300 text-sm font-bold">Log in to manage your pookies!</p>
                        </div>
                        <div class="bg-white rounded-pookie p-8 shadow-xl border-2 border-rose-50 space-y-5">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-[10px] font-black text-rose-300 uppercase tracking-widest mb-1 ml-2">Email</label>
                                    <div class="relative">
                                        <i data-lucide="mail" class="absolute left-4 top-4 text-rose-200" size="20"></i>
                                        <input type="email" id="login-email" class="w-full p-4 pl-12 bg-rose-50/30 rounded-2xl border-2 border-transparent focus:border-rose-200 outline-none font-bold text-rose-700" placeholder="pookie@example.com">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-black text-rose-300 uppercase tracking-widest mb-1 ml-2">Password</label>
                                    <div class="relative">
                                        <i data-lucide="key" class="absolute left-4 top-4 text-rose-200" size="20"></i>
                                        <input type="password" id="login-pass" class="w-full p-4 pl-12 bg-rose-50/30 rounded-2xl border-2 border-transparent focus:border-rose-200 outline-none font-bold text-rose-700" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button onclick="showSoon()" class="text-[10px] font-bold text-rose-400 hover:text-rose-600">Forgot Password?</button>
                                </div>
                            </div>
                            <button onclick="handleLogin()" class="w-full py-4 btn-primary rounded-pookie font-bold text-lg shadow-lg">
                                Login ‚ú®
                            </button>
                             <div class="flex items-center gap-4 my-2">
                                <div class="h-[1px] bg-rose-100 flex-1"></div>
                                <span class="text-[10px] text-rose-200 font-black uppercase">OR</span>
                                <div class="h-[1px] bg-rose-100 flex-1"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="showSoon()" class="py-3 border-2 border-rose-100 rounded-2xl flex items-center justify-center gap-2 text-rose-400 font-bold text-xs hover:bg-rose-50">
                                    <i data-lucide="chrome" size="16"></i> Google
                                </button>
                                <button onclick="showSoon()" class="py-3 border-2 border-rose-100 rounded-2xl flex items-center justify-center gap-2 text-rose-400 font-bold text-xs hover:bg-rose-50">
                                    <i data-lucide="facebook" size="16"></i> Facebook
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3 pt-2">
                            <button onclick="handleNewProfile()" class="w-full py-4 btn-secondary rounded-pookie font-bold text-rose-500">
                                Create New Profile üéÄ
                            </button>
                            <button onclick="handleGuestMode()" class="w-full py-3 text-rose-300 font-black text-xs uppercase tracking-widest hover:text-rose-500">
                                Continue as Guest üëª
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }
            else if (state.view === 'profile') {
                content = `
                <div class="no-scroll bg-[#FFF9FB] p-6 flex flex-col items-center">
                    <div class="glitter-boundary"></div>
                    <div class="w-full max-w-md space-y-6 mt-4 relative z-10">
                        <div class="text-left space-y-2">
                            <h2 class="text-2xl font-black text-rose-900">Pookie Profile ‚ú®</h2>
                            <p class="text-rose-400 text-sm font-bold">Let's make it personal before we start.</p>
                        </div>
                        <div class="bg-white rounded-pookie p-6 shadow-xl border-2 border-rose-50 space-y-5">
                            <div>
                                <label class="block text-rose-900 font-black text-xs mb-2 uppercase tracking-wider">What do pookies call you? üíó</label>
                                <input type="text" id="prof-name" value="${state.profile.name}" oninput="handleProfileLiveUpdate('name', this.value)" class="w-full p-4 bg-rose-50/30 rounded-2xl border-2 border-transparent focus:border-rose-200 outline-none font-bold text-rose-700" placeholder="e.g. Bubbles">
                            </div>
                            <div>
                                <label class="block text-rose-900 font-black text-xs mb-2 uppercase tracking-wider">Birthday üéÇ</label>
                                <input type="date" id="prof-dob" value="${state.profile.dob}" onchange="handleZodiacCalc(this.value)" class="w-full p-4 bg-rose-50/30 rounded-2xl border-2 border-transparent focus:border-rose-200 outline-none font-bold text-rose-700">
                                ${state.profile.zodiac ? `<div class="mt-2 inline-flex items-center px-3 py-1 bg-rose-100 text-rose-500 rounded-full text-xs font-black animate-bounce">${state.profile.zodiac} ‚Ä¢ ${state.profile.element} Baby ‚ú®</div>` : ''}
                            </div>
                            <div>
                                <label class="block text-rose-900 font-black text-xs mb-2 uppercase tracking-wider">Your Vibe üß∏</label>
                                <div class="grid grid-cols-3 gap-2">
                                    ${['üåô Soft', '‚òÄÔ∏è Golden', 'üå∏ Cozy', 'üî• Chaotic', 'üê± Quiet', 'ü´ß Dreamy'].map(v => `
                                        <button onclick="updateVibe('${v}')" class="py-2 px-1 text-[10px] font-black rounded-xl border-2 transition-all ${state.profile.vibe === v ? 'border-rose-400 bg-rose-50 text-rose-500 scale-105' : 'border-rose-50 text-rose-300'}">${v}</button>
                                    `).join('')}
                                </div>
                            </div>
                            <div>
                                <label class="block text-rose-900 font-black text-xs mb-2 uppercase tracking-wider">Known for... ü•≤</label>
                                <input type="text" id="prof-known" value="${state.profile.knownFor}" oninput="handleProfileLiveUpdate('knownFor', this.value)" class="w-full p-4 bg-rose-50/30 rounded-2xl border-2 border-transparent focus:border-rose-200 outline-none font-bold text-rose-700" placeholder="being late but cute...">
                            </div>
                        </div>
                        <button onclick="saveProfile()" class="w-full py-5 btn-primary rounded-pookie font-bold text-xl shadow-lg">
                            Continue üéÄ
                        </button>
                    </div>
                </div>
            `;
            } 
            else if (state.view === 'create') {
                content = `
                    <div class="no-scroll bg-[#FFF9FB] p-4 flex flex-col items-center">
                        <div class="glitter-boundary"></div>
                        <div class="w-full max-w-md flex flex-col h-full relative z-10">
                            <div class="flex items-center justify-between mb-4 mt-2">
                                <div class="flex items-center space-x-3 text-left cursor-pointer" onclick="openProfileEditor()">
                                    <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-2xl shadow-sm border-2 border-white">
                                        ${state.profile.emoji || 'üß∏'}
                                    </div>
                                    <div>
                                        <p class="text-[10px] font-black text-rose-300 uppercase tracking-tighter leading-none mb-1">Creator</p>
                                        <p class="text-lg font-black text-rose-900 leading-none">${state.profile.name}</p>
                                    </div>
                                </div>
                                    <div class="flex gap-4">
                                    <button onclick="openDashboardConfirm()" class="p-2 bg-white rounded-full text-rose-300 hover:text-rose-500 shadow-sm border border-rose-100">
    <i data-lucide="layout-dashboard" size="18"></i>
</button>

                                <button onclick="handleLogout()" class="p-2 bg-white rounded-full text-rose-300 hover:text-rose-500 shadow-sm border border-rose-100">
                                    <i data-lucide="log-out" size="18"></i>
                                </button>
                            </div>
                          </div>
                            <div class="grid grid-cols-3 gap-2 mb-6">
                                ${Object.keys(MODES).map(key => `
                                    <button onclick="setMode('${key}')" 
                                        class="p-2 rounded-2xl flex flex-col items-center justify-center border-2 transition-all ${state.selectedMode === key ? 'bg-rose-100 border-rose-300 text-rose-600' : 'bg-white border-rose-50 text-rose-300'}">
                                        <i data-lucide="${MODES[key].icon}" size="16" class="mb-1"></i>
                                        <span class="text-[10px] font-black uppercase">${MODES[key].label}</span>
                                    </button>
                                `).join('')}
                            </div>
                            <div class="flex-1 overflow-y-auto pr-1 space-y-4 pb-24" style="scrollbar-width: none; -ms-overflow-style: none;">
                                <div class="text-center pb-2">
                                    <h2 class="text-2xl font-black text-rose-900 leading-tight">Craft Your Secrets üéÄ</h2>
                                    <p class="text-rose-400 text-xs font-bold italic">What should your ${MODES[state.selectedMode].label} know?</p>
                                </div>
                                <div id="questionsList" class="space-y-4">
                                    ${state.questions.length === 0 ? '<div class="text-center text-rose-300 text-xs italic">Tap below to add a question!</div>' : ''}
                                    ${state.questions.map((q, idx) => `
                                        <div class="bg-white p-5 rounded-pookie shadow-sm border-2 border-rose-50 space-y-3 relative">
                                            <button onclick="removeQuestion(${idx})" class="absolute top-3 right-3 text-rose-200 hover:text-rose-400 transition-colors">
                                                <i data-lucide="x-circle" size="18"></i>
                                            </button>
                                            <div class="flex justify-between items-center pr-8">
                                                <div class="flex items-center gap-2">
    <div class="text-[10px] font-black text-rose-200 uppercase tracking-widest">Question ${idx + 1}</div>
    <button onclick="openTemplatePicker(${idx})" class="px-2 py-1 bg-rose-50 text-rose-400 text-[8px] font-black rounded-full border border-rose-100 hover:bg-rose-200 transition-all">
        ‚ú® TEMPLATES
    </button>
</div>

                                                <label class="flex items-center cursor-pointer gap-2">
                                                    <span class="text-[10px] font-black text-rose-300 uppercase">Multiple Choice</span>
                                                    <input type="checkbox" ${q.isMultipleChoice ? 'checked' : ''} 
                                                        onchange="toggleMultipleChoice(${idx})" class="accent-rose-400">
                                                </label>
                                            </div>
                                            <input type="text" placeholder="e.g. My favorite snack?" value="${q.question || ''}" 
                                                oninput="updateQuestion(${idx}, 'question', this.value)"
                                                class="w-full font-bold text-rose-900 placeholder-rose-200 outline-none bg-transparent">
                                            ${!q.isMultipleChoice ? `
                                                <input type="text" placeholder="The correct answer is..." value="${q.correctAnswer || ''}"
                                                    oninput="updateQuestion(${idx}, 'correctAnswer', this.value)"
                                                    class="w-full p-3 bg-rose-50/50 rounded-xl text-sm font-bold text-rose-600 outline-none border-2 border-transparent focus:border-rose-100">
                                            ` : `
                                                <div class="space-y-2">
                                                    ${q.options.map((opt, optIdx) => `
                                                        <div class="flex gap-2 items-center">
                                                            <input type="radio" name="correct_${idx}" ${q.correctAnswer === opt && opt !== '' ? 'checked' : ''} 
    onchange="updateQuestion(${idx}, 'correctAnswer', this.nextElementSibling.value)" class="accent-rose-500">

                                                            <input type="text" placeholder="Option ${optIdx + 1}" value="${opt}"
                                                                oninput="updateOption(${idx}, ${optIdx}, this.value)"
                                                                class="flex-1 p-2 bg-rose-50/30 rounded-lg text-xs font-bold text-rose-600 outline-none border border-rose-100">
                                                            ${q.options.length > 2 ? `<button onclick="removeOption(${idx}, ${optIdx})" class="text-rose-200"><i data-lucide="minus-circle" size="14"></i></button>` : ''}
                                                        </div>
                                                    `).join('')}
                                                    ${q.options.length < 6 ? `
                                                        <button onclick="addOption(${idx})" class="text-[10px] font-black text-rose-400 flex items-center gap-1 mt-1">
                                                            <i data-lucide="plus-circle" size="12"></i> Add Option
                                                        </button>
                                                    ` : ''}
                                                    <p class="text-[9px] text-rose-300 italic">* Select the dot next to the correct answer</p>
                                                </div>
                                            `}
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="addQuestion()" class="w-full py-4 border-2 border-dashed border-rose-200 rounded-pookie text-rose-300 font-black flex items-center justify-center space-x-2">
                                    <i data-lucide="plus-circle" size="20"></i>
                                     <span>${state.questions.length === 0 ? 'Add a secret... üéÄ' : 'Add another secret... üéÄ'}</span>
                                </button>
                            </div>
                            <div class="absolute bottom-4 left-0 right-0 pt-4 bg-gradient-to-t from-[#FFF9FB] to-transparent">
                               <button onclick="handleShowPreview()" class="w-full py-5 btn-primary rounded-pill-pookie font-bold text-xl shadow-lg">
                                    Create My Pookie Link ü™Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } 
            else if (state.view === 'preview') {
    const modeLabel = MODES[state.selectedMode].label;
    content = `
        <div class="no-scroll bg-[#FFF9FB] p-6 flex flex-col items-center">
            <div class="w-full max-w-md space-y-6 pb-32">
                <h2 class="text-2xl font-black text-rose-900 text-center">Review Your Quiz ‚ú®</h2>
                <div class="space-y-3">
                    ${state.questions.map((q, idx) => `
                        <div class="bg-white p-4 rounded-pookie border-2 border-rose-50 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] font-black text-rose-200">QUESTION ${idx + 1}</p>
                                <p class="font-bold text-rose-900">${q.question || '...'}</p>
                            </div>
                            <button onclick="editQuestion(${idx})" class="text-rose-300"><i data-lucide="edit-3" size="18"></i></button>
                        </div>
                    `).join('')}
                </div>
                <div class="bg-rose-50 p-4 rounded-pookie border-2 border-dashed border-rose-200">
                    <label class="block text-rose-900 font-black text-xs uppercase mb-2">Message to your ${modeLabel}?</label>
                    <textarea oninput="state.message = this.value" class="w-full p-3 rounded-2xl border-none font-bold text-rose-700 text-sm" rows="2" placeholder="Optional message...">${state.message || ''}</textarea>
                </div>
                <div class="fixed bottom-6 left-0 right-0 px-6 max-w-md mx-auto">
                    <button onclick="confirmFinalCreation()" class="w-full py-5 btn-primary rounded-pill-pookie font-bold text-xl">Confirm & Get Link ü™Ñ</button>
                </div>
            </div>
        </div>
    `;
}

            else if (state.view === 'share') {
                content = `
                    <div class="min-h-screen bg-rose-50/20 p-6 flex flex-col items-center justify-center text-center space-y-10 relative">
                        <button onclick="setView('create')" class="absolute top-6 left-6 p-3 bg-white text-rose-400 rounded-full shadow-md">
                            <i data-lucide="arrow-left" size="24"></i>
                        </button>
                        <div class="relative">
                            <div class="w-28 h-28 bg-white text-rose-400 rounded-pill-pookie shadow-xl flex items-center justify-center animate-pookie-bounce">
                                <i data-lucide="heart" size="56" fill="currentColor"></i>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <h2 class="text-4xl font-black text-rose-900">It's ready! üéÄ</h2>
                            <p class="text-rose-300 font-bold">Send this link to your besties and see who scores highest!</p>
                        </div>
                        <div class="w-full max-w-sm p-6 bg-white rounded-pookie shadow-xl border-4 border-rose-100 flex items-center justify-between gap-4">
                            <p class="text-xs font-bold truncate text-rose-300" id="linkText">${window.location.origin}${window.location.pathname}?q=${state.quizId}</p>
                            <button onclick="copyLink()" class="p-4 bg-rose-400 text-white rounded-2xl shadow-lg"><i data-lucide="copy" size="20"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                            <button onclick="showSoon()" class="flex items-center justify-center gap-2 p-4 bg-white text-rose-400 border-2 border-rose-100 rounded-pookie font-bold text-xs"><i data-lucide="instagram" size="20"></i>IG Story</button>
                            <button onclick="showSoon()" class="flex items-center justify-center gap-2 p-4 bg-white text-rose-400 border-2 border-rose-100 rounded-pookie font-bold text-xs"><i data-lucide="message-circle" size="20"></i>Messages</button>
                        </div>
                        <button onclick="openDashboardConfirm()" class="text-rose-300 font-black uppercase tracking-widest text-[10px]">
                           View Dashboard
                        </button>
                    </div>
                `;
            } else if (state.view === 'attempt') {
           if (state.attemptResult) {
    content = `
        <div class="min-h-screen bg-[#FFF9FB] p-6 flex flex-col items-center py-12">
            <div class="w-full max-w-md space-y-8">
                <div class="text-center space-y-4">
                    <div class="inline-flex flex-col items-center justify-center w-32 h-32 rounded-full bg-white shadow-xl border-4 border-rose-100">
                        <span class="text-4xl font-black text-rose-500">${state.attemptResult.score}/${state.attemptResult.total}</span>
                        <span class="text-[10px] font-black text-rose-300 uppercase">Score</span>
                    </div>
                    <h2 class="text-2xl font-black text-rose-900">
                        ${state.attemptResult.score === state.attemptResult.total ? "Ultimate Pookie! üëë" : "Nice try, Bestie! ‚ú®"}
                    </h2>
                </div>

                <div class="space-y-3">
                    <p class="text-[10px] font-black text-rose-300 uppercase tracking-widest ml-2">Reviewing the tea...</p>
                    ${state.attemptResult.resultsSummary.map((res, i) => `
                        <div class="bg-white p-4 rounded-2xl border-2 ${res.isCorrect ? 'border-emerald-100 bg-emerald-50/20' : 'border-rose-100 bg-rose-50/20'}">
                            <p class="text-xs font-black text-rose-900 mb-2">${i+1}. ${res.question}</p>
                            <div class="flex flex-col gap-1">
                                <p class="text-xs font-bold ${res.isCorrect ? 'text-emerald-600' : 'text-rose-500'}">
                                    Your Answer: ${res.friendAnswer || '(Skipped)'}
                                </p>
                                ${!res.isCorrect ? `<p class="text-[10px] font-bold text-emerald-600">Correct: ${res.correctAnswer}</p>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="bg-white p-6 rounded-pookie shadow-lg border-2 border-rose-100 space-y-3">
                    <div class="flex items-center gap-2">
                        <i data-lucide="message-circle" class="text-rose-400" size="18"></i>
                        <label class="text-sm font-black text-rose-900">Leave a note for ${state.activeQuiz.creatorName}?</label>
                    </div>
                    <textarea id="friend-note" class="w-full p-4 bg-rose-50/50 rounded-xl text-sm font-bold text-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-200" rows="3" placeholder="Write something cute or chaotic..."></textarea>
                    <button onclick="handleSubmitAttempt()" class="w-full py-3 bg-rose-400 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-rose-500 transition-all">
                        Update Message & Finish üéÄ
                    </button>
                </div>

                <button onclick="handleStartOwnQuiz()" class="w-full py-5 btn-primary rounded-pookie font-bold shadow-xl">
                    Create My Own Quiz üç≠
                </button>
            </div>
        </div>
    `;
}
 else if (!state.friendName) {
                    content = `
                        <div class="min-h-screen bg-white p-6 md:max-w-xl md:mx-auto space-y-12">
                            <header class="text-center space-y-4">
                                <div class="inline-block p-4 bg-rose-50 rounded-pookie mb-2"><i data-lucide="heart" class="text-rose-400" fill="currentColor" size="32"></i></div>
                                <h1 class="text-3xl font-black text-rose-900">How well do you know ${state.activeQuiz.creatorName}?</h1>
                            </header>
                            <div class="space-y-8 pt-6">
                                <div class="w-full space-y-2">
                                    <label class="text-sm font-bold text-rose-300 ml-4">What's your name?</label>
                                    <input type="text" id="friendNameInput" placeholder="Type it here... üíï" class="w-full p-5 bg-rose-50/50 border-2 border-transparent focus:border-rose-200 rounded-pookie text-rose-900 outline-none">
                                </div>
                                <button onclick="startAttempt()" class="w-full py-5 text-xl btn-primary rounded-pookie font-bold">I'm Ready! ‚ú®</button>
                            </div>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="min-h-screen bg-white p-6 md:max-w-xl md:mx-auto space-y-12">
                            <header class="text-center space-y-4">
                                <div class="inline-block p-4 bg-rose-50 rounded-pookie mb-2"><i data-lucide="heart" class="text-rose-400" fill="currentColor" size="32"></i></div>
                                <h1 class="text-3xl font-black text-rose-900">How well do you know ${state.activeQuiz.creatorName}?</h1>
                            </header>
                            <div class="space-y-16 pb-32">
                                ${state.activeQuiz.questions.map((q, idx) => `
                                    <div class="space-y-4">
                                        <div class="flex items-center gap-3">
                                            <span class="w-10 h-10 rounded-2xl bg-rose-100 flex items-center justify-center text-rose-400 font-black text-sm">${idx + 1}</span>
                                            <h3 class="text-xl font-bold text-rose-900">${q.question || q.text}</h3>
                                        </div>
                                        ${q.isMultipleChoice ? `
                                            <div class="grid grid-cols-1 gap-3">
                                               ${q.options.map(opt => {
    // Only skip options that are completely empty strings
    if (!opt || opt.trim() === '') return ''; 
    return `
        <button onclick="handleOptionSelect(${idx}, '${opt}')" 
            class="w-full p-4 rounded-2xl text-left font-bold transition-all border-2 ${state.friendAnswers[idx] === opt ? 'bg-rose-100 border-rose-400 text-rose-600' : 'bg-rose-50/50 border-transparent text-rose-400'}">
            ${opt}
        </button>
    `;
}).join('')}

                                            </div>
                                        ` : `
                                            <input type="text" oninput="updateFriendAnswer(${idx}, this.value)" placeholder="The answer is..." class="w-full p-5 bg-rose-50/50 border-2 border-transparent focus:border-rose-200 rounded-pookie text-rose-900 outline-none">
                                        `}
                                    </div>
                                `).join('')}
                                <div class="fixed bottom-8 left-0 right-0 px-6 max-w-xl mx-auto">
                                    <button onclick="handleSubmitAttempt()" class="w-full py-5 text-xl btn-primary rounded-pookie font-bold shadow-2xl">Finished! üç¨</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } 
            else if (state.view === 'dashboard') {
                const sortedAttempts = [...state.attempts].sort((a, b) => b.score - a.score);
                content = `
                    <div class="min-h-screen bg-[#FFFDFE] p-6 md:max-w-xl md:mx-auto space-y-6 pb-24">
                        <header class="flex items-center justify-between py-6">
                            <div class="space-y-1">
                                <h1 class="text-3xl font-black text-rose-900">Results! ‚ú®</h1>
                             <p class="text-rose-300 font-bold">Checking up on ${(state.activeQuiz?.creatorName || state.profile.name)}'s pookies</p>

                            </div>
                             <div class="flex gap-2">
                                <button onclick="handleLogout()" class="p-4 bg-white rounded-pill-pookie shadow-sm text-rose-300 border-2 border-rose-50"><i data-lucide="log-out" size="24"></i></button>
                                <button onclick="setView('share')" class="p-4 bg-white rounded-pill-pookie shadow-sm text-rose-300 border-2 border-rose-50"><i data-lucide="share-2" size="24"></i></button>
                            </div>
                        </header>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-rose-50 p-6 rounded-pookie text-center">
                                <p class="text-[10px] font-black text-rose-300 uppercase tracking-widest mb-1">Total Pookies</p>
                                <p class="text-4xl font-black text-rose-500">${state.attempts.length}</p>
                            </div>
                            <div class="bg-rose-400 text-white p-6 rounded-pookie shadow-xl text-center">
                                <p class="text-[10px] font-black text-rose-100 uppercase tracking-widest mb-1">Top Score</p>
                                <p class="text-4xl font-black">${state.attempts.length ? Math.max(...state.attempts.map(a => a.score)) : 0}</p>
                            </div>
                        </div>
                        <div class="space-y-6 pt-4">
                            <h3 class="font-black text-rose-900 uppercase tracking-widest text-xs flex items-center gap-2">Leaderboard <i data-lucide="stars" size=16 class="text-rose-300"></i></h3>
                            ${state.attempts.length === 0 ? `
                                <div class="bg-white p-12 rounded-pookie border-4 border-dashed border-rose-50 text-center space-y-6">
                                    <i data-lucide="ghost" class="mx-auto text-rose-100" size="48"></i>
                                    <p class="text-rose-300 font-bold">Waiting for your friends to join the party...</p>
                                    <button onclick="setView('share')" class="mx-auto py-3 px-6 bg-white text-rose-400 border-2 border-rose-100 rounded-pookie font-bold">Share the Link üéÄ</button>
                                </div>
                            ` : `
                                
<div class="space-y-4">
    ${sortedAttempts.map((attempt, idx) => `
        <div class="bg-white p-6 rounded-pookie shadow-sm border-2 border-rose-50 space-y-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 rounded-3xl flex items-center justify-center text-xl font-black ${idx === 0 ? 'bg-yellow-100 text-yellow-500' : 'bg-rose-50 text-rose-300'}">
                        ${idx === 0 ? 'üëë' : attempt.friendName.charAt(0)}
                    </div>
                    <div>
                        <h4 class="font-black text-rose-900 text-lg">${attempt.friendName}</h4>
                        <p class="text-[10px] text-rose-200 font-black uppercase tracking-widest">
                            ${new Date(attempt.timestamp).toLocaleDateString()}
                        </p>
                    </div>
                </div>
                <div class="bg-rose-50 px-4 py-2 rounded-2xl text-center min-w-[60px]">
                    <span class="text-xl font-black text-rose-500">${attempt.score}</span>
                    <span class="text-[10px] font-black text-rose-200 block">/${attempt.total}</span>
                </div>
            </div>

            ${(attempt.note && attempt.note.trim() !== "") ? `
    <div class="bg-rose-50/50 p-4 rounded-2xl border-l-4 border-rose-300 relative">
        <p class="text-sm text-rose-800 font-medium italic">"${attempt.note}"</p>
    </div>
` : ''}

        </div>
    `).join('')}
</div>


                            `}
                        </div>
                        <div class="pt-12 text-center">
                            <button onclick="setView('create')" class="text-[10px] font-black text-rose-200 uppercase tracking-[0.3em]">Back to Quiz Creator</button>
                        </div>
                    </div>
                `;
            }

            root.innerHTML = content;
            renderModals(root);
            lucide.createIcons();
        }

        function renderModals(root) {
            if (state.showDashboardConfirm) {
                const modal = document.createElement('div');
                modal.innerHTML = `
                <div class="fixed inset-0 z-[999] flex items-center justify-center bg-rose-100/70 backdrop-blur-md">
                    <div class="bg-white rounded-pookie p-8 w-[90%] max-w-sm text-center shadow-2xl border-4 border-rose-100 animate-pookie-bounce" style="animation-duration: 1.5s;">
                        <div class="text-5xl mb-4">üß∏</div>
                        <h2 class="text-2xl font-black text-rose-900 mb-2">Ready for the tea? üëÄ</h2>
                        <p class="text-rose-300 font-bold text-sm mb-6">Your pookies might surprise you üíó</p>
                        <div class="flex gap-4">
                            <button onclick="confirmDashboard()" class="flex-1 py-4 btn-primary rounded-pookie font-bold">Show me ‚ú®</button>
                            <button onclick="cancelDashboard()" class="flex-1 py-4 bg-rose-50 text-rose-400 rounded-pookie font-bold border-2 border-rose-100">Not yet ü´£</button>
                        </div>
                    </div>
                </div>`;
                root.appendChild(modal);
            }
                             if (state.showTemplateModal) {
    const templates = QUIZ_TEMPLATES[state.selectedMode] || [];
    const modalOverlay = document.createElement('div');
    
    // This ID helps the code identify and remove the modal correctly
    modalOverlay.id = "template-modal-container"; 
    modalOverlay.className = "fixed inset-0 z-[1000] bg-rose-100/70 backdrop-blur-md flex items-center justify-center p-4";
    
    modalOverlay.innerHTML = `
        <div class="bg-white p-6 rounded-pookie w-full max-w-sm shadow-2xl border-4 border-rose-100 space-y-4 relative">
            <div class="flex justify-between items-start w-full">
                <h2 class="text-lg font-black text-rose-900">Choose a Secret ‚ú®</h2>
                <button onclick="closeTemplateModal()" class="text-rose-300 hover:text-rose-500 p-2">
    <i data-lucide="x" size="24"></i>
</button>

            </div>
            <div class="space-y-2 max-h-80 overflow-y-auto pr-2">
                ${templates.map((t, i) => `
    <button onclick="applyTemplate(${i})" 
        class="w-full text-left p-3 rounded-xl border-2 border-rose-50 hover:border-rose-200 hover:bg-rose-50 transition-all">
        <p class="text-sm font-bold text-rose-800">${t.q}</p>
          <p class="text-[9px] font-black text-rose-300 uppercase mt-1">
            ${t.options && t.options.length > 0 ? 'Multiple Choice ‚ú®' : 'One Liner ‚úçÔ∏è'}
    </button>
`).join('')}

            </div>
        </div>`;
    root.appendChild(modalOverlay);
    lucide.createIcons();
}






            if (state.showProfileEditor) {
                const modal = document.createElement('div');
                const hasChanges = JSON.stringify(state.profile) !== JSON.stringify(state.editDraft);
                const activeBar = "bg-rose-50 border-rose-200 opacity-100";
                const dullBar = "bg-gray-50 border-transparent opacity-60";

                modal.innerHTML = `
                <div class="fixed inset-0 z-[999] bg-rose-100/70 backdrop-blur-md flex items-center justify-center p-4">
                    <div class="bg-white p-6 rounded-pookie w-full max-w-sm shadow-2xl border-4 border-rose-100 space-y-5 relative">
                        <button onclick="closeProfileEditor()" class="absolute top-4 left-4 text-rose-300 hover:text-rose-500 transition">
                            <i data-lucide="x" size="20"></i>
                        </button>
                        <h2 class="text-xl font-black text-rose-900 text-center">Edit Profile üß∏</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-[10px] font-black text-rose-300 uppercase tracking-widest mb-1 ml-2">Nickname üíó</label>
                                <input oninput="handleProfileInput('name', this.value)" value="${state.editDraft.name}"
                                    class="w-full p-4 rounded-2xl font-bold outline-none text-rose-700 border-2 transition-all ${state.editDraft.name !== state.profile.name ? activeBar : dullBar}">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-rose-300 uppercase tracking-widest mb-1 ml-2">Birthday üéÇ</label>
                                <input type="date" oninput="handleProfileInput('dob', this.value)" value="${state.editDraft.dob || ''}"
                                    class="w-full p-4 rounded-2xl font-bold outline-none text-rose-700 border-2 transition-all ${state.editDraft.dob !== state.profile.dob ? activeBar : dullBar}">
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-rose-300 uppercase tracking-widest mb-1 ml-2">Known for... ü•≤</label>
                                <input oninput="handleProfileInput('knownFor', this.value)" value="${state.editDraft.knownFor}"
                                    class="w-full p-4 rounded-2xl font-bold outline-none text-rose-700 border-2 transition-all ${state.editDraft.knownFor !== state.profile.knownFor ? activeBar : dullBar}">
                            </div>
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button id="modal-save-btn" onclick="saveProfileEdits()" 
                                class="flex-1 py-4 rounded-pookie font-bold shadow-md transition-colors ${hasChanges ? 'bg-rose-900 text-white' : 'bg-rose-200 text-rose-400 cursor-not-allowed'}">
                                Save ‚ú®
                            </button>
                            <button onclick="closeProfileEditor()" class="flex-1 py-4 bg-rose-50 text-rose-400 rounded-pookie font-bold border-2 border-rose-100">Cancel</button>
                        </div>
                        
                    </div>
                </div>`;
                root.appendChild(modal);
            }
        }

        // --- GLOBAL EXPORTS ---
        window.setView = (view) => {
            state.view = view;
            render();
        };

      

        window.handleLogin = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) { alert("Please fill in your pookie details! ü•∫"); return; }
            state.isLoggedIn = true;
            state.isGuest = false;
            state.userEmail = email;
            if(state.profileCompleted) { setView('create'); } else { setView('profile'); }
        };

        window.handleGuestMode = () => {
            state.isLoggedIn = false;
            state.isGuest = true;
            state.userEmail = 'guest';
            setView('profile');
        };

        window.handleNewProfile = () => {
             state.profile = { ...defaultState.profile };
             state.profileCompleted = false;
             setView('profile');
        };

        window.handleLogout = () => {
            const confirmLogout = confirm("Are you sure you want to leave your pookies? üò¢");
            if(confirmLogout) {
                localStorage.removeItem(STORAGE_KEY);
                state = { ...defaultState };
                location.reload(); 
            }
        };

                window.showToast = (msg, type = 'default') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const themes = {
                success: 'bg-emerald-500 text-white',
                pookie: 'bg-gradient-to-r from-rose-400 to-pink-400 text-white',
                gold: 'bg-amber-400 text-rose-900',
                info: 'bg-rose-100 text-rose-500 border-2 border-rose-200',
                default: 'bg-gray-800 text-white'
            };

            const icons = {
                success: 'check-circle',
                pookie: 'heart',
                gold: 'trophy',
                info: 'sparkles',
                default: 'alert-circle'
            };

            toast.className = `toast-enter ${themes[type] || themes.default} px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 pointer-events-auto mb-3 mx-4`;
            toast.innerHTML = `<i data-lucide="${icons[type] || icons.default}" size="20"></i><span class="font-black text-sm uppercase tracking-wide">${msg}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 400);
            }, 3500);
        };

        // Keep this for the buttons that aren't ready yet
        window.showSoon = () => showToast("Coming soon, Pookie! üöß", "info");


        window.handleProfileLiveUpdate = (field, value) => {
            state.profile[field] = value;
            saveState(); 
        }

        window.updateVibe = (vibe) => {
            state.profile.vibe = vibe;
            render();
        }

        window.handleZodiacCalc = (dateVal) => {
            state.profile.dob = dateVal;
            const z = getZodiac(dateVal);
            state.profile.zodiac = z.n;
            state.profile.element = z.e;
            render();
        }

        window.saveProfile = () => {
            const nameEl = document.getElementById('prof-name');
            // Check if name is empty
            if (!nameEl.value.trim()) { 
                // Adds the 'shake' class we created in Step 1
                nameEl.parentElement.classList.add('shake');
                showToast("What's your name, pookie? ü•∫", "pookie");
                // Removes the shake after half a second so it can shake again later
                setTimeout(() => nameEl.parentElement.classList.remove('shake'), 500);
                return; 
            }
            state.profile.name = nameEl.value;
            state.profile.knownFor = document.getElementById('prof-known')?.value || '';
            state.profileCompleted = true;
            showToast("Profile Saved! ‚ú®", "pookie");
            setView('create');
        };


        window.setMode = (mode) => {
            state.selectedMode = mode;
            render();
        };

        window.addQuestion = () => {
            state.questions.push({ question: '', correctAnswer: '', isMultipleChoice: false, options: ['', ''] });
            render();
        };

        window.removeQuestion = (idx) => {
            state.questions.splice(idx, 1);
            render();
        };

        window.updateQuestion = (idx, field, val) => {
            state.questions[idx][field] = val;
            saveState();
        };

       // Shows the preview page
window.handleShowPreview = () => {
    if (state.questions.length === 0) { alert("Add a question first! üéÄ"); return; }
    state.view = 'preview';
    render();
};

// Takes user back to editor to fix a specific question
window.editQuestion = (idx) => {
    state.view = 'create';
    render();
};

// The actual save function
window.confirmFinalCreation = async () => {
    const id = Math.random().toString(36).substring(2, 8);
    const newQuiz = { 
        id, 
        creatorName: state.profile.name, 
        creatorId: auth?.currentUser?.uid || 'anon', 
        mode: state.selectedMode, 
        questions: state.questions, 
        message: state.message || '',
        createdAt: Date.now() 
    };
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'quizzes', id), newQuiz);
    state.quizId = id;
    state.activeQuiz = newQuiz;
    state.view = 'share';
    render();
};

// Updated: Fresh start for friends who want to make their own quiz
window.handleStartOwnQuiz = () => {
    state.activeQuiz = null;
    state.quizId = null;
    state.attemptResult = null;
    state.questions = []; // Clears old questions
    state.message = '';
    
    const url = new URL(window.location);
    url.searchParams.delete('q');
    window.history.pushState({}, '', url);

    if (state.profileCompleted) { setView('create'); } 
    else { setView('profile'); }
};


        window.copyLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?q=${state.quizId}`;
            navigator.clipboard.writeText(url);
            // This triggers the new Green toast message
            showToast("Link Copied! Share with your pookies! üéÄ", "success");
        };

                   window.handleOptionSelect = (qIdx, value) => {
            state.friendAnswers[qIdx] = value;
            render(); // This ensures the UI highlights the selected pink box immediately
        };

        window.openDashboardConfirm = () => { state.showDashboardConfirm = true; render(); };
        window.confirmDashboard = () => { state.showDashboardConfirm = false; state.view = 'dashboard'; if(state.quizId) loadAttempts(state.quizId); render(); };
        window.cancelDashboard = () => { state.showDashboardConfirm = false; render(); };
        window.openProfileEditor = () => { state.editDraft = { ...state.profile }; state.showProfileEditor = true; render(); };
        window.closeProfileEditor = () => { state.showProfileEditor = false; render(); };
        window.handleProfileInput = (field, value) => { state.editDraft[field] = value; render(); };
        window.saveProfileEdits = () => { if (JSON.stringify(state.profile) === JSON.stringify(state.editDraft)) return; state.profile = { ...state.editDraft }; state.showProfileEditor = false; render(); };
                window.openTemplatePicker = (qIdx) => {
            state.activeTemplateIndex = qIdx;
            state.showTemplateModal = true;
            render();
        };

        window.applyTemplate = (templateIdx) => {
    // We fetch the clean data directly from the list using the index
    const template = QUIZ_TEMPLATES[state.selectedMode][templateIdx];
    const idx = state.activeTemplateIndex;

    state.questions[idx].question = template.q;
    
    // This leaves the dot/answer blank for the user to pick
    state.questions[idx].correctAnswer = ''; 

    if (template.options && template.options.length > 0) {
        state.questions[idx].isMultipleChoice = true;
        state.questions[idx].options = [...template.options];
    } else {
        state.questions[idx].isMultipleChoice = false;
        state.questions[idx].options = ['', '', '', ''];
    }
    state.showTemplateModal = false;
    render();
};
// Add this new global function to handle closing the modal
window.closeTemplateModal = () => {
    state.showTemplateModal = false;
    render();
};


        window.startAttempt = () => {
            const nameInput = document.getElementById('friendNameInput');
            if(!nameInput.value) { alert("Tell me your name! üíï"); return; }
            state.friendName = nameInput.value;
            render();
        };

        window.updateFriendAnswer = (idx, val) => {
            state.friendAnswers[idx] = val;
            saveState(); 
        };

        // --- AFTER (CRASH-PROOF VERSION) ---
window.handleSubmitAttempt = async () => {
    // 1. Calculate score only if we haven't already
    if (!state.attemptResult) {
        let score = 0;
        const resultsSummary = state.activeQuiz.questions.map((q, idx) => {
            const friendAns = (state.friendAnswers[idx] || '').trim();
            const correctAns = (q.correctAnswer || '').trim();
            const isCorrect = friendAns.toLowerCase() === correctAns.toLowerCase();
            if (isCorrect) score++;
            
            return {
                question: q.question || q.text,
                friendAnswer: friendAns,
                correctAnswer: correctAns,
                isCorrect: isCorrect
            };
        });

        state.attemptResult = { 
            quizId: state.activeQuiz.id, 
            friendName: state.friendName, 
            resultsSummary,
            score, 
            total: state.activeQuiz.questions.length, 
            timestamp: Date.now() 
        };
    }

    // 2. Get the note and save to database
    const friendNote = document.getElementById('friend-note')?.value || "";
    const finalAttempt = { ...state.attemptResult, note: friendNote };

    if (!DEV_MODE && db) { 
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attempts'), finalAttempt); 
    } else { 
        const existing = JSON.parse(localStorage.getItem('dev_attempts_' + state.activeQuiz.id) || '[]'); 
        existing.push(finalAttempt); 
        localStorage.setItem('dev_attempts_' + state.activeQuiz.id, JSON.stringify(existing)); 
    }
    
    // 3. Show success and reset
    showToast("Message sent to " + state.activeQuiz.creatorName + "! ‚ú®", "success");
    setTimeout(() => handleStartOwnQuiz(), 1500); 
};



        const getZodiac = (dateString) => {
            if(!dateString) return {n: "", e: "", s: ""};
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return {n: "Aries", e: "Fire", s: "‚ôà"};
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return {n: "Taurus", e: "Earth", s: "‚ôâ"};
            if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return {n: "Gemini", e: "Air", s: "‚ôä"};
            if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return {n: "Cancer", e: "Water", s: "‚ôã"};
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return {n: "Leo", e: "Fire", s: "‚ôå"};
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return {n: "Virgo", e: "Earth", s: "‚ôç"};
            if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return {n: "Libra", e: "Air", s: "‚ôé"};
            if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return {n: "Scorpio", e: "Water", s: "‚ôè"};
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return {n: "Sagittarius", e: "Fire", s: "‚ôê"};
            if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return {n: "Capricorn", e: "Earth", s: "‚ôë"};
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return {n: "Aquarius", e: "Air", s: "‚ôí"};
            return {n: "Pisces", e: "Water", s: "‚ôì"};
        };

        window.toggleMultipleChoice = (idx) => { state.questions[idx].isMultipleChoice = !state.questions[idx].isMultipleChoice; render(); };
        window.addOption = (qIdx) => { if (state.questions[qIdx].options.length < 6) { state.questions[qIdx].options.push(''); render(); } };
        window.removeOption = (qIdx, optIdx) => { state.questions[qIdx].options.splice(optIdx, 1); render(); };
        window.updateOption = (qIdx, optIdx, val) => { state.questions[qIdx].options[optIdx] = val; saveState(); };

                async function loadQuiz(id) {
            let quizData = null;
            // Fetch the quiz data from Firebase or LocalStorage
            if (!DEV_MODE && db) { 
                try { 
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'quizzes', id)); 
                    if (snap.exists()) quizData = snap.data(); 
                } catch(e) { console.error("Load Error", e); } 
            } else { 
                const localData = localStorage.getItem('dev_quiz_' + id); 
                if(localData) quizData = JSON.parse(localData); 
            }

            if (quizData) { 
                state.activeQuiz = quizData; 
                state.quizId = id; 
                // Always set view to 'attempt' so friends see the quiz questions
                state.view = 'attempt'; 
            } else { 
                alert("Quiz not found! ü•∫"); 
                state.view = 'landing'; 
            }
            render();
        }


                // Add "query" and "where" to your imports at the very top of the script if they aren't there
        // import { ..., query, where } from "..."

        function loadAttempts(id) {
            if (!DEV_MODE && db) {
                // Create a reference to the attempts collection
                const attemptsRef = collection(db, 'artifacts', appId, 'public', 'data', 'attempts');
                
                // Set up a real-time listener
                onSnapshot(attemptsRef, (snapshot) => {
                    const allAttempts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Filter attempts for this specific quiz
                    state.attempts = allAttempts.filter(a => a.quizId === id);
                    render(); // Re-render the dashboard automatically when a new friend finishes
                }, (error) => {
                    console.error("Dashboard Listener Error:", error);
                });
            } else {
                state.attempts = JSON.parse(localStorage.getItem('dev_attempts_' + id) || '[]');
                render();
            }
        }

        async function init() {
            if (!DEV_MODE && auth) { try { await signInAnonymously(auth); } catch(e) { console.error("Auth Error", e); } }
            const params = new URLSearchParams(window.location.search);
            const qId = params.get('q');
            if (qId) { await loadQuiz(qId); } else { render(); }
        } 
        init();
    </script>
</body>
</html>
